{% extends "base.html" %}
{% block content %}

<h1 style="color:#f3e7b3; margin-bottom:10px;">
    {{ job.job_number }} â€“ {{ job.title }}
</h1>

<!-- MINI MAP -->
<div id="miniMap" class="mini-map"></div>

<script>
    var miniMap = L.map('miniMap', { zoomControl: false, attributionControl: false })
        .setView([{{ site.lat }}, {{ site.lng }}], 15);

    L.tileLayer(`https://api.maptiler.com/maps/hybrid/256/{z}/{x}/{y}.jpg?key={{ maptiler_key }}`, {
        tileSize: 256,
        maxZoom: 18
    }).addTo(miniMap);

    L.marker([{{ site.lat }}, {{ site.lng }}]).addTo(miniMap);
</script>

<!-- JOB INFO SECTION -->
<div class="content-box">
    <h2 style="color:#d4af37;">Job Information</h2>

    <!-- Division Badge -->
    {% if job.division == 'Domestic' %}
        <span class="div-badge div-domestic">Domestic</span>
    {% elif job.division == 'Ag' %}
        <span class="div-badge div-ag">Ag</span>
    {% elif job.division == 'Drilling' %}
        <span class="div-badge div-drilling">Drilling</span>
    {% elif job.division == 'Electrical' %}
        <span class="div-badge div-electrical">Electrical</span>
    {% endif %}

    <!-- Status -->
    <span class="status-tag {{ job.status|lower }}">
        {{ job.status }}
    </span>

    <p style="margin-top:15px;">
        <strong>Start:</strong> {{ job.start_date }} <br>
        <strong>End:</strong> {{ job.end_date }} <br>
        <strong>Duration:</strong> {{ job.duration }} days
    </p>

    {% if job.description %}
    <p><strong>Description:</strong><br>{{ job.description }}</p>
    {% endif %}

    <a class="btn" href="{{ url_for('edit_job', job_id=job.id) }}">
        Edit Job
    </a>
</div>

<!-- GANTT CHART -->
<div class="content-box">
    <h2 style="color:#d4af37;">Job Timeline</h2>

    <div id="ganttHere" style="height:200px;"></div>

    <script>
        var ganttTask = [
            {
                id: "{{ job.id }}",
                name: "{{ job.title }}",
                start: "{{ job.start_date }}",
                end: "{{ job.end_date }}",
                progress: 100,
            }
        ];

        new Gantt("#ganttHere", ganttTask, {
            view_mode: "Day",
            date_format: "YYYY-MM-DD",
            custom_popup_html: null
        });
    </script>
</div>

<!-- FILE UPLOAD SECTION -->
<div class="content-box">
    <h2 style="color:#d4af37;">Attachments</h2>

    <form action="{{ url_for('upload_job_file', job_id=job.id) }}" method="POST" enctype="multipart/form-data">
        <input type="file" name="file" required>
        <button class="btn" type="submit">Upload File</button>
    </form>

    <hr style="border-color:#d4af3750;">

    {% if files|length == 0 %}
        <p>No attachments yet.</p>
    {% else %}
        {% for f in files %}
            {% if f.type == 'pdf' %}
                <p><a class="data-link" href="{{ f.url }}" target="_blank">ðŸ“„ {{ f.filename }}</a></p>
            {% elif f.type == 'image' %}
                <img src="{{ f.url }}" style="max-width: 150px; border:1px solid #d4af37; border-radius:6px; margin:8px;">
            {% elif f.type == 'video' %}
                <video controls style="max-width:250px; margin:8px;">
                    <source src="{{ f.url }}">
                </video>
            {% endif %}
        {% endfor %}
    {% endif %}
</div>

<!-- NOTES SECTION -->
<div class="content-box">
    <h2 style="color:#d4af37;">Job Notes</h2>

    <form method="POST" action="{{ url_for('add_job_note', job_id=job.id) }}">
        <textarea name="note" rows="3" placeholder="Add a note..." required></textarea>
        <button class="btn" type="submit">Add Note</button>
    </form>

    <hr style="border-color:#d4af3750;">

    {% if notes|length == 0 %}
        <p>No notes yet.</p>
    {% else %}
        {% for n in notes %}
            <div style="margin-bottom:15px;">
                <p style="margin-bottom:4px;">
                    <strong style="color:#f3e7b3;">{{ n.timestamp }}</strong>
                </p>
                <p>{{ n.text }}</p>
            </div>
        {% endfor %}
    {% endif %}
</div>

{% endblock %}
