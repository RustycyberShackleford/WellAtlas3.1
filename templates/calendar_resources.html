{% extends "base.html" %}
{% block content %}
<div class="card glass">
  <h2>Crew Scheduling</h2>
  <div class="calendar-filters">
    <select id="crewFilter"><option value="">All Crew</option></select>
    <select id="customerFilter"><option value="">All Customers</option></select>
    <select id="categoryFilter">
      <option value="">All Divisions</option>
      <option>Drilling</option>
      <option>Electrical</option>
      <option>Domestic</option>
      <option>Ag</option>
    </select>
    <select id="statusFilter">
      <option value="">All Status</option>
      <option>Planned</option>
      <option>Scheduled</option>
      <option>In Progress</option>
      <option>Complete</option>
      <option>On Hold</option>
    </select>
  </div>
  <div id="calendar"></div>
</div>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script>
async function j(u){const r=await fetch(u);if(!r.ok)throw new Error(await r.text());return await r.json();}
function colorFor(cat){const map={"Drilling":"#b8860b","Electrical":"#5457ff","Domestic":"#16a34a","Ag":"#e11d48"};return map[cat]||"#b8860b";}
async function loadFilters(){
  const crew=await j('/api/crew');
  const crewSel=document.getElementById('crewFilter');
  crewSel.innerHTML='<option value="">All Crew</option>';
  crew.forEach(p=>{const o=document.createElement('option');o.value=p.id;o.textContent=p.name;crewSel.appendChild(o);});
  const customers=await j('/api/customers');
  const custSel=document.getElementById('customerFilter');
  custSel.innerHTML='<option value="">All Customers</option>';
  customers.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.name;custSel.appendChild(o);});
}
function buildQuery(info){
  const qs=new URLSearchParams();
  const crewId=document.getElementById('crewFilter').value;
  const cust=document.getElementById('customerFilter').value;
  const cat=document.getElementById('categoryFilter').value;
  const stat=document.getElementById('statusFilter').value;
  if(crewId)qs.set('crew_id',crewId);
  if(cust)qs.set('customer_id',cust);
  if(cat)qs.set('job_category',cat);
  if(stat)qs.set('status',stat);
  qs.set('start',info.startStr);qs.set('end',info.endStr);
  return qs.toString();
}
document.addEventListener('DOMContentLoaded',async function(){
  await loadFilters();
  const el=document.getElementById('calendar');
  const cal=new FullCalendar.Calendar(el,{
    initialView:'timeGridWeek',height:'auto',
    headerToolbar:{left:'prev,next today',center:'title',right:'dayGridMonth,timeGridWeek,listWeek'},
    events:function(info,success,failure){
      const url='/api/calendar_assignments?'+buildQuery(info);
      fetch(url).then(r=>r.json()).then(rows=>{
        success(rows.map(r=>({
          id:r.id,title:`${r.crew} â†’ ${r.job_number} (${r.site})`,
          start:r.start,end:r.end,url:r.url,
          backgroundColor:colorFor(r.category),borderColor:colorFor(r.category)
        })));
      }).catch(failure);
    }
  });
  cal.render();
  ['crewFilter','customerFilter','categoryFilter','statusFilter'].forEach(id=>{
    document.getElementById(id).addEventListener('change',()=>cal.refetchEvents());
  });
});
</script>
{% endblock %}
