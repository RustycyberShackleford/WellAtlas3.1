{% extends "base.html" %}
{% block content %}
<div class="card glass">
  <h2>Assign Crew to Job #{{ job.job_number }}</h2>
  <div class="job-meta">
    <div><b>{{ job.customer }}</b> — {{ job.site }}</div>
    <div>{{ job.job_category }} · {{ job.status }}</div>
  </div>
  <form id="assignForm" class="form-row">
    <select name="crew_id" id="crewSelect" required></select>
    <input type="date" name="start_date" value="{{ job.start_date or '' }}" required>
    <input type="date" name="end_date" value="{{ job.end_date or '' }}" required>
    <input name="role" placeholder="Role (optional)">
    <button class="btn gold" type="submit">Assign</button>
  </form>
</div>
<script>
async function j(u,opts){const r=await fetch(u,opts||{});if(!r.ok)throw new Error(await r.text());return await r.json();}
async function loadCrew(){
  const list=await j('/api/crew');
  const sel=document.getElementById('crewSelect');sel.innerHTML='';
  list.forEach(p=>{const o=document.createElement('option');o.value=p.id;o.textContent=`${p.name} — ${p.role||''}`;sel.appendChild(o);});
}
document.getElementById('assignForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const fd=new FormData(e.target);
  const body=JSON.stringify(Object.fromEntries(fd.entries()));
  await j('/api/assign/{{ job.id }}',{method:'POST',headers:{'Content-Type':'application/json'},body});
  alert('Assigned');
  window.location.href='/calendar/resources';
});
loadCrew();
</script>
{% endblock %}
