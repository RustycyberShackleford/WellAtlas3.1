
{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2 style="margin:0 0 8px">Gantt — Work Timeline</h2>
  <p style="color:#475569;margin:0 0 12px">Color-coded by category. Drag horizontally to see more.</p>
  <div class="glass" style="padding:10px;border-radius:12px;overflow-x:auto;">
    <canvas id="gantt" height="560"></canvas>
  </div>
</section>
<script>
  const catColors = { Domestic:'#60a5fa', Drilling:'#f59e0b', Ag:'#22c55e', Electrical:'#a78bfa' };
  fetch('/api/jobs_timeline').then(r=>r.json()).then(rows=>{
    const labels = rows.map(r=>`${r.customer} / ${r.site} • ${r.job_number}`);
    const minDate = Math.min(...rows.map(r=>new Date(r.start).getTime()));
    const maxDate = Math.max(...rows.map(r=>new Date(r.end).getTime()));
    const dataSets = [{
      label:'Jobs',
      data: rows.map((r,i)=>({ x: [new Date(r.start), new Date(r.end)], y: i })),
      borderWidth: 12,
      borderColor: rows.map(r=>catColors[r.category]||'#94a3b8'),
      segment: { borderColor: ctx=>ctx.p0.raw && (catColors[rows[ctx.p0.parsed.y].category]||'#94a3b8') },
      pointRadius:0
    }];
    const ctx = document.getElementById('gantt').getContext('2d');
    new Chart(ctx, {
      type:'line',
      data:{ labels:labels, datasets:dataSets },
      options:{
        responsive:true, maintainAspectRatio:false,
        scales:{
          x:{ type:'time', time:{ unit:'day' }, min:minDate, max:maxDate },
          y:{ type:'category', labels:labels, ticks:{ autoSkip:false, callback:(v)=>'' } }
        },
        plugins:{
          legend:{ display:false },
          tooltip:{
            callbacks:{
              title:(items)=>labels[items[0].parsed.y],
              label:(item)=>{
                const r = rows[item.parsed.y];
                return `${r.category}: ${new Date(r.start).toLocaleDateString()} → ${new Date(r.end).toLocaleDateString()}`;
              }
            }
          }
        },
        elements:{ line:{ borderCapStyle:'round' } }
      }
    });
  });
</script>
{% endblock %}
