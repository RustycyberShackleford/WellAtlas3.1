{% extends "base.html" %}
{% block content %}
<div class="card glass">
  <h2>Gantt — {{ mode|default('global')|capitalize }}</h2>
  <canvas id="ganttCanvas" height="360"></canvas>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
const ctx=document.getElementById('ganttCanvas').getContext('2d');
const mode="{{ mode or 'global' }}";
const siteId="{{ site_id or '' }}";
const jobId="{{ job_id or '' }}";
function toMs(d){return new Date(d).getTime();}
async function fetchData(){
  if(mode==='site'&&siteId){
    const r=await fetch(`/api/gantt/site/${siteId}`);const j=await r.json();const items=j.items||[];
    return{labels:items.map(x=>x.job_number),starts:items.map(x=>x.start?toMs(x.start):null),ends:items.map(x=>x.end?toMs(x.end):null)};
  }else if(mode==='job'&&jobId){
    const r=await fetch(`/api/gantt/job/${jobId}`);const j=await r.json();const items=j.items||[];
    return{labels:items.map(x=>x.name),starts:items.map(x=>x.start?toMs(x.start):null),ends:items.map(x=>x.end?toMs(x.end):null)};
  }else{
    const r=await fetch('/api/jobs_timeline');const rows=await r.json();
    return{labels:rows.map(r=>`${r.site} • ${r.job_number}`),starts:rows.map(r=>r.start?toMs(r.start):null),ends:rows.map(r=>r.end?toMs(r.end):null)};
  }
}
function renderGantt(data){
  const xs=data.starts.filter(Boolean);const xe=data.ends.filter(Boolean);
  if(xs.length===0||xe.length===0)return;
  const min=Math.min(...xs);const max=Math.max(...xe);
  new Chart(ctx,{type:'bar',data:{labels:data.labels,datasets:[{label:'Timeline',indexAxis:'y',parsing:false,
    data:data.labels.map((_,i)=>({x:[data.starts[i],data.ends[i]],y:i})),borderWidth:1}]},
    options:{responsive:true,maintainAspectRatio:false,
      scales:{x:{type:'time',time:{unit:'day'},min,max},y:{ticks:{autoSkip:true,maxTicksLimit:25}}},
      plugins:{legend:{display:false}}}});
}
fetchData().then(renderGantt);
</script>
{% endblock %}
